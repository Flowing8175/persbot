# 새로운 기능 가이드 (Enhancement Guide)

## 📋 개요

두 가지 새로운 기능이 추가되었습니다:

1. **요약에서 기억 추출** - 채널 요약 시 자동으로 중요 정보를 기억으로 저장
2. **채널 메시지 자동 수집** - 지정한 채널의 모든 메시지를 자동으로 수집하고 인덱싱

---

## 🎯 기능 1: 요약에서 기억 추출

### 개요

사용자가 `!요약` 명령어로 채널을 요약할 때, **요약의 핵심 내용을 자동으로 기억으로 저장**합니다.

### 작동 방식

```
사용자: !요약
  ↓
봇: 최근 30분의 대화 요약 생성
  ↓
봇: 요약 내용을 자동으로 기억에 저장
  ↓
사용자: 요약 결과 받음
  ↓
다음 대화: 이전 요약 내용을 참고하여 응답
```

### 예시

**상황:**
```
#일반 채널에서 게임 개발 논의가 있었음

User1: "버그 찾기는 정말 힘들어"
User2: "VS 디버거 쓰면 쉽다고"
User3: "C++은 메모리 관리도 신경써야지"
```

**요약 명령:**
```
!요약
```

**봇의 처리:**
1. 최근 30분 메시지 수집
2. Gemini로 요약 생성:
   ```
   "게임 개발 중 버그 찾기는 VS 디버거로 처리할 수 있으며,
    C++은 메모리 관리를 신경써야 한다."
   ```
3. 자동으로 기억 저장:
   ```
   [일반 채널 요약] 게임 개발 중 버그 찾기는 VS 디버거로...
   ```
4. Discord에 요약 표시

**나중의 대화:**
```
User: "@소예봇 버그는 어떻게 찾아?"

봇: (저장된 요약을 참고)
"아까 이야기 나왔는데 VS 디버거 쓰면 쉽다고 했잖아"
```

### 기억 저장 상세

| 항목 | 값 |
|------|-----|
| 메모리 타입 | `key_memory` (중요한 기억) |
| 내용 | `[채널이름 채널 요약] 요약내용` |
| 중요도 | 0.6 (중간) |
| 저장 대상 | 요약 명령어를 실행한 사용자 |

### 설정

기본적으로 **자동 활성화**됩니다 (메모리 시스템이 활성화되어 있으면).

비활성화하려면:
```python
# config.py에서
enable_memory_system = False  # 전체 메모리 시스템 비활성화
```

### 주의사항

- ✅ 요약에 민감한 정보가 없는지 확인하세요
- ✅ 저장되는 기억은 데이터베이스에 영구 저장됩니다
- ✅ 필요하면 `!기억삭제` 명령어로 삭제 가능
- ✅ 요약 기억은 중요도 0.6으로 저장되어 사용자가 저장한 기억(0.8)보다 낮음

---

## 📊 기능 2: 채널 메시지 자동 수집

### 개요

**지정한 채널의 모든 메시지를 자동으로 수집하여** 시맨틱 서치를 위해 인덱싱합니다.

시맨틱 서치가 더 정확한 기억을 찾을 수 있도록 지식 베이스를 구축합니다.

### 주요 특징

```
✅ 자동: 채널 설정 후 모든 메시지 자동 수집
✅ 지능형: 자동으로 주제를 분류하고 추출
✅ 선택적: 시맨틱 서치 모드에서만 작동
✅ 효율적: 관리자만 설정 가능
✅ 마이크로: 낮은 중요도로 저장 (0.3)
```

### 작동 흐름

```
1. 관리자가 !채널설정 #채널이름 실행
   ↓
2. 그 채널의 모든 신규 메시지 자동 감지
   ↓
3. 각 메시지:
   - 텍스트 정제 (멘션, URL 제거)
   - 주제 분류 (프로그래밍, 게임, 요리 등)
   - 임베딩 생성
   - DB에 저장
   ↓
4. 사용자가 질문할 때:
   시맨틱 서치가 이 채널의 메시지들을 검색하여
   관련된 것만 로드
```

### 설정 방법

#### Step 1: 시맨틱 서치 활성화

먼저 시맨틱 서치가 활성화되어 있어야 합니다:

```
!기억설정 semantic_search
```

응답:
```
✓ 기억 검색 모드를 semantic_search로 변경했습니다.
```

#### Step 2: 채널 설정

관리자가 다음 명령어 실행:

```
!채널설정 #일반
```

응답:
```
✓ 채널 설정 완료!
#일반의 메시지들이 이제부터 시맨틱 서치를 위해 수집됩니다.
주의: 이 채널의 모든 메시지가 데이터베이스에 저장됩니다.
```

#### Step 3: 상태 확인

```
!채널상태
```

출력:
```
📊 채널 메시지 수집 상태

상태: 🟢 활성화
수집 중인 채널: #일반
처리된 메시지: 42개
검색 모드: semantic_search
```

#### Step 4: 수집 중지 (필요 시)

```
!채널설정해제
```

응답:
```
✓ 채널 설정 해제 완료!
#일반의 메시지 수집이 중지되었습니다.
(총 42개 메시지 처리됨)
```

### 저장되는 데이터 구조

```
채널 메시지 수집 시스템:

모든 수집된 메시지는:
- User ID: "channel_{channel_id}"
- Memory Type: "fact"
- Importance: 0.3 (매우 낮음)
- Content: "[#채널이름] 메시지 내용"
```

### 주제 분류

자동으로 다음 주제를 분류합니다:

```
🎮 프로그래밍
   키워드: 코드, 코딩, 프로그래밍, 개발, 버그, 디버깅

🎮 게임
   키워드: 게임, 플레이, 전략, 발로란트, 마크

🍳 요리
   키워드: 요리, 밥, 음식, 먹다, 맛있다

✈️ 여행
   키워드: 여행, 가다, 놀러, 관광, 여행지

📚 공부
   키워드: 공부, 배우다, 시험, 수학, 과학
```

### 시맨틱 서치와의 상호작용

**예시 시나리오:**

```
1️⃣ 채널 수집 시작
!채널설정 #일반

2️⃣ 채널에서 메시지들이 축적됨
User1: "프로그래밍에서 포인터 이해하기"
User2: "C++은 메모리 효율이 좋다"
User3: "버그 찾기 팁"
...

3️⃣ 사용자가 질문
@소예봇 포인터에 대해 설명해줄 수 있어?

4️⃣ 시맨틱 서치 작동
- "포인터"를 벡터로 변환
- 수집된 채널 메시지와 비교
- 가장 관련된 메시지들 검색:
  ✓ "프로그래밍에서 포인터 이해하기" (유사도 0.92)
  ✓ "C++은 메모리 효율이 좋다" (유사도 0.78)
  ✗ "버그 찾기 팁" (유사도 0.34 - 제외)

5️⃣ 관련 메시지들을 기억으로 주입
AI가 참고하여 응답 생성

6️⃣ 더 정확한 응답 제공
"포인터는 메모리 주소를 가리키는...
(채널에서 본 내용을 바탕으로)"
```

### 장점

```
✅ 시맨틱 서치 성능 향상
   - 더 많은 관련 메모리 확보
   - 더 정확한 검색 결과

✅ 지식 베이스 구축
   - 채널의 정보들이 자동으로 인덱싱됨
   - AI가 채널의 논의 내용을 학습

✅ 메모리 효율
   - 낮은 중요도(0.3)로 저장
   - 사용자 메모리(0.8)가 더 우선됨
   - 필요 시 쉽게 정리 가능

✅ 자동화
   - 수동 작업 없음
   - 지정 후 완전 자동
```

### 주의사항

⚠️ **중요한 주의사항:**

```
❌ DO NOT USE 금지:
   - 민감한 정보가 있는 채널
   - 개인 정보가 나누어지는 채널
   - 비공개 대화
   - 정책/규칙 논의
   - 보안 관련 채널

✅ RECOMMENDED 추천:
   - 공개 기술 논의 채널
   - 프로젝트 논의 채널
   - 공개 학습 채널
   - 커뮤니티 채널
   - 일반 대화 채널
```

### 권한 요구사항

```
!채널설정          → 관리자(Administrator) 권한 필요
!채널설정해제      → 관리자(Administrator) 권한 필요
!채널상태          → 누구나 가능
```

### 실제 사용 시나리오

#### 시나리오 1: 기술 커뮤니티

```
상황:
- #기술 채널에서 매일 프로그래밍 논의
- 다양한 언어, 프레임워크 정보 공유

해결:
!채널설정 #기술

결과:
- 모든 기술 정보가 자동 인덱싱
- 사용자가 프로그래밍 질문하면
  #기술 채널의 관련 정보가 자동으로 참고됨
- "이전에 #기술에서 본 것처럼..."이라고 답변 가능
```

#### 시나리오 2: 학습 그룹

```
상황:
- #수학 채널에서 매주 수학 문제 풀이
- 다양한 풀이 방법 공유

해결:
!채널설정 #수학

결과:
- 모든 풀이 방법이 인덱싱됨
- 사용자가 수학 문제 물으면
  비슷한 문제의 풀이 방법이 자동 참고됨
```

#### 시나리오 3: 게임 커뮤니티

```
상황:
- #발로란트 채널에서 게임 전략 논의
- 캐릭터, 맵, 컨트롤 팁 공유

해결:
!채널설정 #발로란트

결과:
- 모든 게임 팁이 인덱싱됨
- 플레이어가 질문하면
  채널에서 배운 전략이 자동 참고됨
```

---

## 🔧 기술 상세

### 메시지 전처리 과정

```
원본 메시지:
"@User1 #일반 채널에서 https://example.com 봤어?"

1️⃣ 멘션/해시태그 제거
"User1 일반 채널에서 https://example.com 봤어?"

2️⃣ URL 제거 (Optional)
"User1 일반 채널에서 봤어?"

3️⃣ 공백 정규화
"User1 일반 채널에서 봤어?"

4️⃣ 길이 제한 (500자)
"User1 일반 채널에서 봤어?" (제한 없음)

5️⃣ 최종 저장
저장된 내용: "[#일반] User1 일반 채널에서 봤어?"
```

### 주제 추출 알고리즘

```
메시지: "C++ 포인터 구조체 공부 중입니다"

키워드 매칭:
- "프로그래밍" 그룹:
  ✓ "구조체" 매칭 → "프로그래밍" 포함
  ✓ "C++" 매칭 → "프로그래밍" 포함
  ✓ "포인터" 매칭 → "프로그래밍" 포함
  ✓ "공부" 매칭 → "공부" 포함

결과 주제: ["프로그래밍", "공부"]
```

### 데이터 저장 구조

```
Database 구조:

users 테이블:
user_id: "channel_123456789"
username: "Channel: #일반"

memories 테이블:
user_id: "channel_123456789"
memory_type: "fact"
content: "[#일반] 원본 메시지 내용"
importance_score: 0.3

interaction_patterns 테이블:
user_id: "channel_123456789"
favorite_topics: {"프로그래밍": 45, "게임": 12, ...}
total_messages: 150
```

---

## 📊 성능과 리소스

### 채널 수집의 리소스 사용

```
상황별 리소스 사용:

1️⃣ 메시지 도착 시:
   - CPU: ~5ms (전처리)
   - 메모리: ~0.1MB (임시)
   - DB: ~2KB (저장)

2️⃣ 매분 처리:
   - 100개 메시지: ~500ms
   - 1000개 메시지: ~5초

3️⃣ 시맨틱 서치 사용 시:
   - 임베딩 생성: ~100ms/메시지
   - 캐시 히트: 즉시 (1ms)
```

### 최적화 팁

```
✅ 좋은 실천:
   - 공개 채널만 수집
   - 필요한 채널만 설정
   - 정기적으로 !채널상태 확인
   - 필요하면 !기억초기화로 정리

❌ 피해야 할 것:
   - 너무 많은 채널 동시 수집
   - 채널 설정/해제 반복
   - 민감한 정보 있는 채널
```

---

## 📖 빠른 참조 가이드

### 명령어 요약

```
기억 자동 추출:
- !요약          → 요약 생성 (자동으로 기억 저장)
- !요약 1시간    → 시간 지정 (기억 저장)
- !요약 id 123   → ID 기준 (기억 저장)

채널 수집 (관리자만):
- !채널설정 #채널       → 수집 시작
- !채널설정해제         → 수집 중지
- !채널상태             → 상태 확인

기본 기억 명령어:
- !기억 [내용]          → 수동 저장
- !기억목록             → 확인
- !기억삭제 [ID]        → 삭제
- !기억통계             → 통계
```

### 트러블슈팅

| 문제 | 해결책 |
|------|--------|
| "시맨틱 서치 없이는 수집 안 됨" | `!기억설정 semantic_search` 실행 |
| "권한 없음" 에러 | 관리자 권한 필요 |
| "채널을 찾을 수 없음" | 올바른 채널 이름 사용 (예: #일반) |
| "수집이 너무 느림" | 시맨틱 서치 임베딩 로드 중 (처음 1회만) |

---

## 🎓 결론

### 기능 1 (요약 기억)
- **언제 사용**: 중요한 논의를 요약할 때
- **이점**: 자동으로 기억 저장, 부담 없음
- **주의**: 민감한 정보 확인

### 기능 2 (채널 수집)
- **언제 사용**: 지식 베이스 구축할 때
- **이점**: 시맨틱 서치 정확도 향상
- **주의**: 관리자만, 공개 채널만

**두 기능 모두 시맨틱 서치 성능을 높이는 데 도움이 됩니다!**
